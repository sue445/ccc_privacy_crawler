# https://circleci.com/docs/config-sample
machine:
  ruby:
    version: 2.4.1

  # Add some environment variables
  environment:
    COVERAGE: true
    RACK_ENV: test

## Customize dependencies
#dependencies:

## Customize database setup
database:
  override:
    # replace CircleCI's generated database.yml
    - cp spec/circle_ci/database.yml.postgresql config/database.yml
    - bundle exec rake ar:migrate:reset

## Customize test commands
test:
  override:
    - bundle exec rspec
    - bundle exec rubocop

## Customize deployment commands
deployment:
  production:
    branch: master
    commands:
      - ./script/notify_to_slack.sh "Heroku Deploy" "Deploy start"
      - heroku config:add BUNDLE_WITHOUT="test:development" --app $HEROKU_APP_NAME
      - git push git@heroku.com:$HEROKU_APP_NAME.git $CIRCLE_SHA1:refs/heads/master
      - heroku run rake ar:migrate --app $HEROKU_APP_NAME:
          timeout: 400 # if your deploys take a long time
      - ./script/notify_to_slack.sh "Heroku Deploy" "Deploy successful"
